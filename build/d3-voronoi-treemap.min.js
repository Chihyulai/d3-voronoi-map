!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3-array"),require("d3-polygon"),require("d3-weighted-voronoi")):"function"==typeof define&&define.amd?define(["exports","d3-array","d3-polygon","d3-weighted-voronoi"],e):e(t.d3=t.d3||{},t.d3,t.d3,t.d3)}(this,function(t,e,i,n){"use strict";function r(){this.history=[],this.historyLength=10,this.totalAvailableArea=NaN,this.initialIndexWeight=3,this.indexWeightDecrement=1}function o(){function t(t,e){return W(e.x-t.x)+W(e.y-t.y)}function o(t){c(),p=t.length,y=Math.abs(i.polygonArea(j.clip())),w=m*y,L.clear().totalArea(y);var e,n=0,r=f(t),o=!1;for(M(r,n);!(o||n>=b);)r=a(r,L.ratio()),n++,e=g(r),L.add(e),o=e<w,console.log("error %: "+Math.round(100*e*1e3/y)/1e3),M(r,n);return{polygons:r,iterationCount:n,convergenceRatio:e/y}}function a(t,e){var i;return h(t,e),i=t.map(function(t){return t.site.originalObject}),t=j(i),t.length<p&&console.log("at least 1 site has no area, which is not supposed to arise"),s(t,e),i=t.map(function(t){return t.site.originalObject}),t=j(i),t.length<p&&console.log("at least 1 site has no area, which is not supposed to arise"),t}function h(t,e){var n,r,o,a,h,s,u=[];n=.5*e;for(var l=0;l<p;l++)r=t[l],o=r.site.originalObject,a=i.polygonCentroid(r),h=a[0]-o.x,s=a[1]-o.y,h*=1-n,s*=1-n,o.x+=h,o.y+=s,u.push(o);v(u)}function s(t,e){var n,r,o,a,h,s,u=[];n=.1*e;for(var l=0;l<p;l++)r=t[l],o=r.site.originalObject,a=i.polygonArea(r),h=o.targetedArea/a,h=Math.max(h,.9+n),h=Math.min(h,1.1-n),s=o.weight*h,s=Math.max(s,k),o.weight=s,u.push(o);v(u)}function u(e){var i,n,r,o,a,h,s,u=0;do{i=!1;for(var l=0;l<p;l++){n=e[l];for(var g=l+1;g<p;g++)if(r=e[g],n.weight>r.weight?(o=n,a=r):(o=r,a=n),h=t(n,r),h<o.weight-a.weight){s=h+a.weight/2,s=Math.max(s,k),o.weight=s,i=!0,u++;break}if(i)break}}while(i);u>0&&console.log("# fix: "+u)}function l(e){var i,n,r,o,a,h,s,u=0;do{i=!1;for(var l=0;l<p;l++){n=e[l];for(var g=l+1;g<p;g++)if(r=e[g],n.weight>r.weight?(o=n,a=r):(o=r,a=n),h=t(n,r),h<o.weight-a.weight){s=o.weight-a.weight-h,a.weight+=s+k,i=!0,u++;break}if(i)break}}while(i);u>0&&console.log("# fix: "+u)}function g(t){for(var e,n,r,o=0,a=0;a<p;a++)e=t[a],n=e.site.originalObject,r=i.polygonArea(e),o+=Math.abs(n.targetedArea-r);return o}function c(){switch(O){case 0:v=u;break;case 1:v=l;break;default:console.log("Variant of 'handleOverweighted' is unknown")}}function f(t){var e,i,n=t.reduce(function(t,e){return Math.max(t,x(e))},-(1/0)),r=n*A;return e=t.map(function(t,e){return{index:e,weight:Math.max(x(t),r),originalData:t}}),i=d(e),j(i)}function d(t){var n,r,o=t.reduce(function(t,e){return t+=e.weight},0),a=y/p,h=e.extent(j.clip().map(function(t){return t[0]})),s=e.extent(j.clip().map(function(t){return t[1]})),u=h[1]-h[0],l=s[1]-s[0],g=a/2;return t.map(function(t){for(n=h[0]+u*Math.random(),r=s[0]+l*Math.random();!i.polygonContains(j.clip(),[n,r]);)n=h[0]+u*Math.random(),r=s[0]+l*Math.random();return{index:t.index,targetedArea:y*t.weight/o,data:t,x:n,y:r,weight:g}})}var p,y,w,v,x=function(t){return t.weight},m=.01,b=50,A=.01,M=function(t,e){return!0},k=1,j=n.weightedVoronoi(),L=new r,O=1,W=(Math.sqrt,function(t){return Math.pow(t,2)});return o.weight=function(t){return arguments.length?(x=t,o):x},o.convergenceRatio=function(t){return arguments.length?(m=t,o):m},o.maxIterationCount=function(t){return arguments.length?(b=t,o):b},o.minWeightRatio=function(t){return arguments.length?(A=t,o):A},o.tick=function(t){return arguments.length?(M=t,o):M},o.clip=function(t){return arguments.length?(j.clip(t),o):j.clip()},o}r.prototype.reset=function(){return this.history=[],this.historyLength=10,this.totalAvailableArea=NaN,this},r.prototype.clear=function(){return this.history=[],this},r.prototype.length=function(t){return arguments.length?(this.historyLength=t,this):this.historyLength},r.prototype.totalArea=function(t){return arguments.length?(this.totalAvailableArea=t,this):this.totalAvailableArea},r.prototype.add=function(t){return this.history.unshift(t),this.history.length>this.historyLength&&this.history.pop(),this},r.prototype.ratio=function(){var t,e,i,n,r=0,o=0,a=this.initialIndexWeight;if(this.history.length<this.historyLength)return 0;if(this.history[0]>this.totalAvailableArea/10)return 0;t=this.history[0],e=this.history[1],i=t-e>0;for(var h=0;h<this.historyLength-2;h++)t=e,e=this.history[h+2],t-e>0!=i&&(r+=a,i=!i),o+=a,a-=this.indexWeightDecrement,a<1&&(a=1);return n=r/o,n>0&&console.log("flickering mitigation ratio: "+Math.floor(1e3*n)/1e3),n},t.voronoiTreemap=o,Object.defineProperty(t,"__esModule",{value:!0})});