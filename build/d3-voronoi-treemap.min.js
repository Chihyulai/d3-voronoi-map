!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3-array"),require("d3-polygon"),require("d3-weighted-voronoi")):"function"==typeof define&&define.amd?define(["exports","d3-array","d3-polygon","d3-weighted-voronoi"],e):e(t.d3=t.d3||{},t.d3,t.d3,t.d3)}(this,function(t,e,r,n){"use strict";function i(){this.lastAreaError=NaN,this.lastGrowth=NaN,this.growthChanges=[],this.growthChangesLength=10,this.totalAvailableArea=NaN,this.growthChangeWeights=h(this.growthChangesLength),this.growthChangeWeightsSum=a(this.growthChangeWeights)}function o(t,e){return t>=e?1:-1}function h(t){for(var e=3,r=1,n=1,i=e,o=[],h=0;h<t;h++)o.push(i),i-=r,i<n&&(i=n);return o}function a(t){for(var e=0,r=0;r<t.length;r++)e+=t[r];return e}function g(){function t(t,e){return k(e.x-t.x)+k(e.y-t.y)}function o(t){c(),p=t.length,d=Math.abs(r.polygonArea(M.clip())),v=y*d,W.clear().totalArea(d);var e,n=0,i=f(t),o=!1;for(b(i,n);!(o||n>=A);)i=h(i,W.ratio()),n++,e=l(i),W.add(e),o=e<v,console.log("error %: "+Math.round(100*e*1e3/d)/1e3),b(i,n);return{polygons:i,iterationCount:n,convergenceRatio:e/d}}function h(t,e){var r;return a(t,e),r=t.map(function(t){return t.site.originalObject}),t=M(r),t.length<p&&console.log("at least 1 site has no area, which is not supposed to arise"),g(t,e),r=t.map(function(t){return t.site.originalObject}),t=M(r),t.length<p&&console.log("at least 1 site has no area, which is not supposed to arise"),t}function a(t,e){var n,i,o,h,a,g,s,u=[],l=.5;n=l*e,i=1-n;for(var c=0;c<p;c++)o=t[c],h=o.site.originalObject,a=r.polygonCentroid(o),g=a[0]-h.x,s=a[1]-h.y,g*=i,s*=i,h.x+=g,h.y+=s,u.push(h);C(u)}function g(t,e){var n,i,o,h,a,g,s=[],u=.1;n=u*e;for(var l=0;l<p;l++)i=t[l],o=i.site.originalObject,h=r.polygonArea(i),a=o.targetedArea/h,a=Math.max(a,1-u+n),a=Math.min(a,1+u-n),g=o.weight*a,g=Math.max(g,N),o.weight=g,s.push(o);C(s)}function s(e){var r,n,i,o,h,a,g,s=0;do{r=!1;for(var u=0;u<p;u++){n=e[u];for(var l=u+1;l<p;l++)if(i=e[l],n.weight>i.weight?(o=n,h=i):(o=i,h=n),a=t(n,i),a<o.weight-h.weight){g=a+h.weight/2,g=Math.max(g,N),o.weight=g,r=!0,s++;break}if(r)break}}while(r);s>0&&console.log("# fix: "+s)}function u(e){var r,n,i,o,h,a,g,s=0;do{r=!1;for(var u=0;u<p;u++){n=e[u];for(var l=u+1;l<p;l++)if(i=e[l],n.weight>i.weight?(o=n,h=i):(o=i,h=n),a=t(n,i),a<o.weight-h.weight){g=o.weight-h.weight-a,h.weight+=g+N,r=!0,s++;break}if(r)break}}while(r);s>0&&console.log("# fix: "+s)}function l(t){for(var e,n,i,o=0,h=0;h<p;h++)e=t[h],n=e.site.originalObject,i=r.polygonArea(e),o+=Math.abs(n.targetedArea-i);return o}function c(){switch(L){case 0:C=s;break;case 1:C=u;break;default:console.log("Variant of 'handleOverweighted' is unknown")}}function f(t){var e,r,n=t.reduce(function(t,e){return Math.max(t,m(e))},-(1/0)),i=n*x;return e=t.map(function(t,e){return{index:e,weight:Math.max(m(t),i),originalData:t}}),r=w(e),M(r)}function w(t){var n,i,o=t.reduce(function(t,e){return t+=e.weight},0),h=d/p,a=e.extent(M.clip().map(function(t){return t[0]})),g=e.extent(M.clip().map(function(t){return t[1]})),s=a[1]-a[0],u=g[1]-g[0],l=h/2;return t.map(function(t){for(n=a[0]+s*Math.random(),i=g[0]+u*Math.random();!r.polygonContains(M.clip(),[n,i]);)n=a[0]+s*Math.random(),i=g[0]+u*Math.random();return{index:t.index,targetedArea:d*t.weight/o,data:t,x:n,y:i,weight:l}})}var p,d,v,C,m=function(t){return t.weight},y=.01,A=50,x=.01,b=function(t,e){return!0},N=1,M=n.weightedVoronoi(),W=new i,L=1,k=(Math.sqrt,function(t){return Math.pow(t,2)});return o.weight=function(t){return arguments.length?(m=t,o):m},o.convergenceRatio=function(t){return arguments.length?(y=t,o):y},o.maxIterationCount=function(t){return arguments.length?(A=t,o):A},o.minWeightRatio=function(t){return arguments.length?(x=t,o):x},o.tick=function(t){return arguments.length?(b=t,o):b},o.clip=function(t){return arguments.length?(M.clip(t),o):M.clip()},o}i.prototype.reset=function(){return this.lastAreaError=NaN,this.lastGrowth=NaN,this.growthChanges=[],this.growthChangesLength=10,this.growthChangeWeights=h(this.growthChangesLength),this.growthChangeWeightsSum=a(this.growthChangeWeights),this.totalAvailableArea=NaN,this},i.prototype.clear=function(){return this.lastAreaError=NaN,this.lastGrowth=NaN,this.growthChanges=[],this},i.prototype.length=function(t){return arguments.length?(this.growthChangesLength=t,this.growthChangeWeights=h(this.growthChangesLength),this.growthChangeWeightsSum=a(this.growthChangeWeights),this):this.growthChangesLength},i.prototype.totalArea=function(t){return arguments.length?(this.totalAvailableArea=t,this):this.totalAvailableArea},i.prototype.add=function(t){var e,r;return e=this.lastAreaError,this.lastAreaError=t,isNaN(e)||(r=this.lastGrowth,this.lastGrowth=o(this.lastAreaError,e)),isNaN(r)||this.growthChanges.unshift(this.lastGrowth!=r),this.growthChanges.length>this.growthChangesLength&&this.growthChanges.pop(),this},i.prototype.ratio=function(){var t,e=0;if(this.growthChanges.length<this.growthChangesLength)return 0;if(this.lastAreaError>this.totalAvailableArea/10)return 0;for(var r=0;r<this.growthChangesLength;r++)this.growthChanges[r]&&(e+=this.growthChangeWeights[r]);return t=e/this.growthChangeWeightsSum,t>0&&console.log("flickering mitigation ratio: "+Math.floor(1e3*t)/1e3),t},t.voronoiTreemap=g,Object.defineProperty(t,"__esModule",{value:!0})});