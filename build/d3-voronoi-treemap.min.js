!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports,require("d3-array"),require("d3-polygon"),require("d3-weighted-voronoi")):"function"==typeof define&&define.amd?define(["exports","d3-array","d3-polygon","d3-weighted-voronoi"],i):i(t.d3=t.d3||{},t.d3,t.d3,t.d3)}(this,function(t,i,e,n){"use strict";function r(){this.history=[],this.directions=[],this.historyLength=10,this.directionLength=this.historyLength-1,this.totalAvailableArea=NaN,this.initialIndexWeight=3,this.indexWeightDecrement=1}function o(t,i){return t>=i?1:-1}function h(){function t(t,i){return W(i.x-t.x)+W(i.y-t.y)}function o(t){l(),p=t.length,y=Math.abs(e.polygonArea(k.clip())),w=m*y,j.clear().totalArea(y);var i,n=0,r=f(t),o=!1;for(M(r,n);!(o||n>=b);)r=h(r,j.ratio()),n++,i=g(r),j.add(i),o=i<w,console.log("error %: "+Math.round(100*i*1e3/y)/1e3),M(r,n);return{polygons:r,iterationCount:n,convergenceRatio:i/y}}function h(t,i){var e;return a(t,i),e=t.map(function(t){return t.site.originalObject}),t=k(e),t.length<p&&console.log("at least 1 site has no area, which is not supposed to arise"),s(t,i),e=t.map(function(t){return t.site.originalObject}),t=k(e),t.length<p&&console.log("at least 1 site has no area, which is not supposed to arise"),t}function a(t,i){var n,r,o,h,a,s,u,c=[],g=.5;n=g*i,r=1-n;for(var l=0;l<p;l++)o=t[l],h=o.site.originalObject,a=e.polygonCentroid(o),s=a[0]-h.x,u=a[1]-h.y,s*=r,u*=r,h.x+=s,h.y+=u,c.push(h);v(c)}function s(t,i){var n,r,o,h,a,s,u=[],c=.1;n=c*i;for(var g=0;g<p;g++)r=t[g],o=r.site.originalObject,h=e.polygonArea(r),a=o.targetedArea/h,a=Math.max(a,1-c+n),a=Math.min(a,1+c-n),s=o.weight*a,s=Math.max(s,L),o.weight=s,u.push(o);v(u)}function u(i){var e,n,r,o,h,a,s,u=0;do{e=!1;for(var c=0;c<p;c++){n=i[c];for(var g=c+1;g<p;g++)if(r=i[g],n.weight>r.weight?(o=n,h=r):(o=r,h=n),a=t(n,r),a<o.weight-h.weight){s=a+h.weight/2,s=Math.max(s,L),o.weight=s,e=!0,u++;break}if(e)break}}while(e);u>0&&console.log("# fix: "+u)}function c(i){var e,n,r,o,h,a,s,u=0;do{e=!1;for(var c=0;c<p;c++){n=i[c];for(var g=c+1;g<p;g++)if(r=i[g],n.weight>r.weight?(o=n,h=r):(o=r,h=n),a=t(n,r),a<o.weight-h.weight){s=o.weight-h.weight-a,h.weight+=s+L,e=!0,u++;break}if(e)break}}while(e);u>0&&console.log("# fix: "+u)}function g(t){for(var i,n,r,o=0,h=0;h<p;h++)i=t[h],n=i.site.originalObject,r=e.polygonArea(i),o+=Math.abs(n.targetedArea-r);return o}function l(){switch(O){case 0:v=u;break;case 1:v=c;break;default:console.log("Variant of 'handleOverweighted' is unknown")}}function f(t){var i,e,n=t.reduce(function(t,i){return Math.max(t,x(i))},-(1/0)),r=n*A;return i=t.map(function(t,i){return{index:i,weight:Math.max(x(t),r),originalData:t}}),e=d(i),k(e)}function d(t){var n,r,o=t.reduce(function(t,i){return t+=i.weight},0),h=y/p,a=i.extent(k.clip().map(function(t){return t[0]})),s=i.extent(k.clip().map(function(t){return t[1]})),u=a[1]-a[0],c=s[1]-s[0],g=h/2;return t.map(function(t){for(n=a[0]+u*Math.random(),r=s[0]+c*Math.random();!e.polygonContains(k.clip(),[n,r]);)n=a[0]+u*Math.random(),r=s[0]+c*Math.random();return{index:t.index,targetedArea:y*t.weight/o,data:t,x:n,y:r,weight:g}})}var p,y,w,v,x=function(t){return t.weight},m=.01,b=50,A=.01,M=function(t,i){return!0},L=1,k=n.weightedVoronoi(),j=new r,O=1,W=(Math.sqrt,function(t){return Math.pow(t,2)});return o.weight=function(t){return arguments.length?(x=t,o):x},o.convergenceRatio=function(t){return arguments.length?(m=t,o):m},o.maxIterationCount=function(t){return arguments.length?(b=t,o):b},o.minWeightRatio=function(t){return arguments.length?(A=t,o):A},o.tick=function(t){return arguments.length?(M=t,o):M},o.clip=function(t){return arguments.length?(k.clip(t),o):k.clip()},o}r.prototype.reset=function(){return this.history=[],this.directions=[],this.historyLength=10,this.directionLength=this.historyLength-1,this.totalAvailableArea=NaN,this},r.prototype.clear=function(){return this.history=[],this.directions=[],this},r.prototype.length=function(t){return arguments.length?(this.historyLength=t,this.directionLength=this.historyLength-1,this):this.historyLength},r.prototype.totalArea=function(t){return arguments.length?(this.totalAvailableArea=t,this):this.totalAvailableArea},r.prototype.add=function(t){return this.history.unshift(t),this.history.length>1&&this.directions.unshift(o(t,this.history[1])),this.history.length>this.historyLength&&(this.history.pop(),this.directions.pop()),this},r.prototype.ratio=function(){var t,i,e=0,n=0,r=this.initialIndexWeight;if(this.history.length<this.historyLength)return 0;if(this.history[0]>this.totalAvailableArea/10)return 0;t=this.directions[0];for(var o=0;o<this.directionLength-1;o++)t!=this.directions[o+1]&&(e+=r,t=-t),n+=r,r-=this.indexWeightDecrement,r<1&&(r=1);return i=e/n,i>0&&console.log("flickering mitigation ratio: "+Math.floor(1e3*i)/1e3),i},t.voronoiTreemap=h,Object.defineProperty(t,"__esModule",{value:!0})});