!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3-array"),require("d3-polygon"),require("d3-weighted-voronoi")):"function"==typeof define&&define.amd?define(["exports","d3-array","d3-polygon","d3-weighted-voronoi"],e):e(t.d3=t.d3||{},t.d3,t.d3,t.d3)}(this,function(t,e,r,o){"use strict";function n(){this.lastAreaError=NaN,this.secondToLastAreaError=NaN,this.lastGrowth=NaN,this.secondToLastGrowth=NaN,this.growthChanges=[],this.growthChangesLength=10,this.totalAvailableArea=NaN,this.growthChangeWeights=h(this.growthChangesLength),this.growthChangeWeightsSum=a(this.growthChangeWeights)}function i(t,e){return t>=e?1:-1}function h(t){for(var e=3,r=1,o=1,n=e,i=[],h=0;h<t;h++)i.push(n),n-=r,n<o&&(n=o);return i}function a(t){for(var e=0,r=0;r<t.length;r++)e+=t[r];return e}function s(){function t(t,e){return T(e.x-t.x)+T(e.y-t.y)}function i(t){c(),d=t.length,p=Math.abs(r.polygonArea(b.clip())),C=A*p,M.clear().totalArea(p);var e,o=0,n=f(t),i=!1;for(L(n,o);!(i||o>=m);)n=h(n,M.ratio()),o++,e=l(n),M.add(e),i=e<C,console.log("error %: "+Math.round(100*e*1e3/p)/1e3),L(n,o);return{polygons:n,iterationCount:o,convergenceRatio:e/p}}function h(t,e){var r;return a(t,e),r=t.map(function(t){return t.site.originalObject}),t=b(r),t.length<d&&console.log("at least 1 site has no area, which is not supposed to arise"),s(t,e),r=t.map(function(t){return t.site.originalObject}),t=b(r),t.length<d&&console.log("at least 1 site has no area, which is not supposed to arise"),t}function a(t,e){var o,n,i,h,a,s,g,u=[],l=.5;o=l*e,n=1-o;for(var c=0;c<d;c++)i=t[c],h=i.site.originalObject,a=r.polygonCentroid(i),s=a[0]-h.x,g=a[1]-h.y,s*=n,g*=n,h.x+=s,h.y+=g,u.push(h);v(u)}function s(t,e){var o,n,i,h,a,s,g=[],u=.1;o=u*e;for(var l=0;l<d;l++)n=t[l],i=n.site.originalObject,h=r.polygonArea(n),a=i.targetedArea/h,a=Math.max(a,1-u+o),a=Math.min(a,1+u-o),s=i.weight*a,s=Math.max(s,x),i.weight=s,g.push(i);v(g)}function g(e){var r,o,n,i,h,a,s,g=0;do{r=!1;for(var u=0;u<d;u++){o=e[u];for(var l=u+1;l<d;l++)if(n=e[l],o.weight>n.weight?(i=o,h=n):(i=n,h=o),a=t(o,n),a<i.weight-h.weight){s=a+h.weight/2,s=Math.max(s,x),i.weight=s,r=!0,g++;break}if(r)break}}while(r);g>0&&console.log("# fix: "+g)}function u(e){var r,o,n,i,h,a,s,g=0;do{r=!1;for(var u=0;u<d;u++){o=e[u];for(var l=u+1;l<d;l++)if(n=e[l],o.weight>n.weight?(i=o,h=n):(i=n,h=o),a=t(o,n),a<i.weight-h.weight){s=i.weight-h.weight-a,h.weight+=s+x,r=!0,g++;break}if(r)break}}while(r);g>0&&console.log("# fix: "+g)}function l(t){for(var e,o,n,i=0,h=0;h<d;h++)e=t[h],o=e.site.originalObject,n=r.polygonArea(e),i+=Math.abs(o.targetedArea-n);return i}function c(){switch(E){case 0:v=g;break;case 1:v=u;break;default:console.log("Variant of 'handleOverweighted' is unknown")}}function f(t){var e,r,o=t.reduce(function(t,e){return Math.max(t,N(e))},-(1/0)),n=o*y;return e=t.map(function(t,e){return{index:e,weight:Math.max(N(t),n),originalData:t}}),r=w(e),b(r)}function w(t){var o,n,i=t.reduce(function(t,e){return t+=e.weight},0),h=p/d,a=e.extent(b.clip().map(function(t){return t[0]})),s=e.extent(b.clip().map(function(t){return t[1]})),g=a[1]-a[0],u=s[1]-s[0],l=h/2;return t.map(function(t){for(o=a[0]+g*Math.random(),n=s[0]+u*Math.random();!r.polygonContains(b.clip(),[o,n]);)o=a[0]+g*Math.random(),n=s[0]+u*Math.random();return{index:t.index,targetedArea:p*t.weight/i,data:t,x:o,y:n,weight:l}})}var d,p,C,v,N=function(t){return t.weight},A=.01,m=50,y=.01,L=function(t,e){return!0},x=1,b=o.weightedVoronoi(),M=new n,E=1,T=(Math.sqrt,function(t){return Math.pow(t,2)});return i.weight=function(t){return arguments.length?(N=t,i):N},i.convergenceRatio=function(t){return arguments.length?(A=t,i):A},i.maxIterationCount=function(t){return arguments.length?(m=t,i):m},i.minWeightRatio=function(t){return arguments.length?(y=t,i):y},i.tick=function(t){return arguments.length?(L=t,i):L},i.clip=function(t){return arguments.length?(b.clip(t),i):b.clip()},i}n.prototype.reset=function(){return this.lastAreaError=NaN,this.secondToLastAreaError=NaN,this.lastGrowth=NaN,this.secondToLastGrowth=NaN,this.growthChanges=[],this.growthChangesLength=10,this.growthChangeWeights=h(this.growthChangesLength),this.growthChangeWeightsSum=a(this.growthChangeWeights),this.totalAvailableArea=NaN,this},n.prototype.clear=function(){return this.lastAreaError=NaN,this.secondToLastAreaError=NaN,this.lastGrowth=NaN,this.secondToLastGrowth=NaN,this.growthChanges=[],this},n.prototype.length=function(t){return arguments.length?(this.growthChangesLength=t,this.growthChangeWeights=h(this.growthChangesLength),this.growthChangeWeightsSum=a(this.growthChangeWeights),this):this.growthChangesLength},n.prototype.totalArea=function(t){return arguments.length?(this.totalAvailableArea=t,this):this.totalAvailableArea},n.prototype.add=function(t){return this.secondToLastAreaError=this.lastAreaError,this.lastAreaError=t,isNaN(this.secondToLastAreaError)||(this.secondToLastGrowth=this.lastGrowth,this.lastGrowth=i(this.lastAreaError,this.secondToLastAreaError)),isNaN(this.secondToLastGrowth)||this.growthChanges.unshift(this.lastGrowth!=this.secondToLastGrowth),this.growthChanges.length>this.growthChangesLength&&this.growthChanges.pop(),this},n.prototype.ratio=function(){var t,e=0;if(this.growthChanges.length<this.growthChangesLength)return 0;if(this.lastAreaError>this.totalAvailableArea/10)return 0;for(var r=0;r<this.growthChangesLength;r++)this.growthChanges[r]&&(e+=this.growthChangeWeights[r]);return t=e/this.growthChangeWeightsSum,t>0&&console.log("flickering mitigation ratio: "+Math.floor(1e3*t)/1e3),t},t.voronoiTreemap=s,Object.defineProperty(t,"__esModule",{value:!0})});