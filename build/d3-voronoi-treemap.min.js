!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3-array"),require("d3-polygon"),require("d3-weighted-voronoi")):"function"==typeof define&&define.amd?define(["exports","d3-array","d3-polygon","d3-weighted-voronoi"],e):e(t.d3=t.d3||{},t.d3,t.d3,t.d3)}(this,function(t,e,r,n){"use strict";function o(){this.lastAreaError=NaN,this.secondToLastAreaError=NaN,this.lastGrowth=NaN,this.secondToLastGrowth=NaN,this.growthChanges=[],this.growthChangesLength=10,this.totalAvailableArea=NaN,this.initialIndexWeight=3,this.indexWeightDecrement=1}function i(t,e){return t>=e?1:-1}function a(){function t(t,e){return T(e.x-t.x)+T(e.y-t.y)}function i(t){c(),w=t.length,p=Math.abs(r.polygonArea(L.clip())),N=x*p,M.clear().totalArea(p);var e,n=0,o=f(t),i=!1;for(b(o,n);!(i||n>=y);)o=a(o,M.ratio()),n++,e=u(o),M.add(e),i=e<N,console.log("error %: "+Math.round(100*e*1e3/p)/1e3),b(o,n);return{polygons:o,iterationCount:n,convergenceRatio:e/p}}function a(t,e){var r;return h(t,e),r=t.map(function(t){return t.site.originalObject}),t=L(r),t.length<w&&console.log("at least 1 site has no area, which is not supposed to arise"),s(t,e),r=t.map(function(t){return t.site.originalObject}),t=L(r),t.length<w&&console.log("at least 1 site has no area, which is not supposed to arise"),t}function h(t,e){var n,o,i,a,h,s,g,l=[],u=.5;n=u*e,o=1-n;for(var c=0;c<w;c++)i=t[c],a=i.site.originalObject,h=r.polygonCentroid(i),s=h[0]-a.x,g=h[1]-a.y,s*=o,g*=o,a.x+=s,a.y+=g,l.push(a);A(l)}function s(t,e){var n,o,i,a,h,s,g=[],l=.1;n=l*e;for(var u=0;u<w;u++)o=t[u],i=o.site.originalObject,a=r.polygonArea(o),h=i.targetedArea/a,h=Math.max(h,1-l+n),h=Math.min(h,1+l-n),s=i.weight*h,s=Math.max(s,C),i.weight=s,g.push(i);A(g)}function g(e){var r,n,o,i,a,h,s,g=0;do{r=!1;for(var l=0;l<w;l++){n=e[l];for(var u=l+1;u<w;u++)if(o=e[u],n.weight>o.weight?(i=n,a=o):(i=o,a=n),h=t(n,o),h<i.weight-a.weight){s=h+a.weight/2,s=Math.max(s,C),i.weight=s,r=!0,g++;break}if(r)break}}while(r);g>0&&console.log("# fix: "+g)}function l(e){var r,n,o,i,a,h,s,g=0;do{r=!1;for(var l=0;l<w;l++){n=e[l];for(var u=l+1;u<w;u++)if(o=e[u],n.weight>o.weight?(i=n,a=o):(i=o,a=n),h=t(n,o),h<i.weight-a.weight){s=i.weight-a.weight-h,a.weight+=s+C,r=!0,g++;break}if(r)break}}while(r);g>0&&console.log("# fix: "+g)}function u(t){for(var e,n,o,i=0,a=0;a<w;a++)e=t[a],n=e.site.originalObject,o=r.polygonArea(e),i+=Math.abs(n.targetedArea-o);return i}function c(){switch(E){case 0:A=g;break;case 1:A=l;break;default:console.log("Variant of 'handleOverweighted' is unknown")}}function f(t){var e,r,n=t.reduce(function(t,e){return Math.max(t,v(e))},-(1/0)),o=n*m;return e=t.map(function(t,e){return{index:e,weight:Math.max(v(t),o),originalData:t}}),r=d(e),L(r)}function d(t){var n,o,i=t.reduce(function(t,e){return t+=e.weight},0),a=p/w,h=e.extent(L.clip().map(function(t){return t[0]})),s=e.extent(L.clip().map(function(t){return t[1]})),g=h[1]-h[0],l=s[1]-s[0],u=a/2;return t.map(function(t){for(n=h[0]+g*Math.random(),o=s[0]+l*Math.random();!r.polygonContains(L.clip(),[n,o]);)n=h[0]+g*Math.random(),o=s[0]+l*Math.random();return{index:t.index,targetedArea:p*t.weight/i,data:t,x:n,y:o,weight:u}})}var w,p,N,A,v=function(t){return t.weight},x=.01,y=50,m=.01,b=function(t,e){return!0},C=1,L=n.weightedVoronoi(),M=new o,E=1,T=(Math.sqrt,function(t){return Math.pow(t,2)});return i.weight=function(t){return arguments.length?(v=t,i):v},i.convergenceRatio=function(t){return arguments.length?(x=t,i):x},i.maxIterationCount=function(t){return arguments.length?(y=t,i):y},i.minWeightRatio=function(t){return arguments.length?(m=t,i):m},i.tick=function(t){return arguments.length?(b=t,i):b},i.clip=function(t){return arguments.length?(L.clip(t),i):L.clip()},i}o.prototype.reset=function(){return this.lastAreaError=NaN,this.secondToLastAreaError=NaN,this.lastGrowth=NaN,this.secondToLastGrowth=NaN,this.growthChanges=[],this.growthChangesLength=10,this.totalAvailableArea=NaN,this},o.prototype.clear=function(){return this.lastAreaError=NaN,this.secondToLastAreaError=NaN,this.lastGrowth=NaN,this.secondToLastGrowth=NaN,this.growthChanges=[],this},o.prototype.length=function(t){return arguments.length?(this.growthChangesLength=t,this):this.growthChangesLength},o.prototype.totalArea=function(t){return arguments.length?(this.totalAvailableArea=t,this):this.totalAvailableArea},o.prototype.add=function(t){return this.secondToLastAreaError=this.lastAreaError,this.lastAreaError=t,isNaN(this.secondToLastAreaError)||(this.secondToLastGrowth=this.lastGrowth,this.lastGrowth=i(this.lastAreaError,this.secondToLastAreaError)),isNaN(this.secondToLastGrowth)||this.growthChanges.unshift(this.lastGrowth!=this.secondToLastGrowth),this.growthChanges.length>this.growthChangesLength&&this.growthChanges.pop(),this},o.prototype.ratio=function(){var t,e=0,r=0,n=this.initialIndexWeight;if(this.growthChanges.length<this.growthChangesLength)return 0;if(this.lastAreaError>this.totalAvailableArea/10)return 0;for(var o=0;o<this.growthChangesLength;o++)this.growthChanges[o]&&(e+=n),r+=n,n-=this.indexWeightDecrement,n<1&&(n=1);return t=e/r,t>0&&console.log("flickering mitigation ratio: "+Math.floor(1e3*t)/1e3),t},t.voronoiTreemap=a,Object.defineProperty(t,"__esModule",{value:!0})});