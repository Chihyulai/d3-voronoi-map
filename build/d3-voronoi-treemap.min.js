!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3-array"),require("d3-polygon"),require("d3-weighted-voronoi")):"function"==typeof define&&define.amd?define(["exports","d3-array","d3-polygon","d3-weighted-voronoi"],e):e(t.d3=t.d3||{},t.d3,t.d3,t.d3)}(this,function(t,e,r,n){"use strict";function i(){this.growthChangesLength=s,this.totalAvailableArea=NaN,this.lastAreaError=NaN,this.lastGrowth=NaN,this.growthChanges=[],this.growthChangeWeights=a(this.growthChangesLength),this.growthChangeWeightsSum=h(this.growthChangeWeights)}function o(t,e){return t>=e?1:-1}function a(t){for(var e=3,r=1,n=1,i=e,o=[],a=0;a<t;a++)o.push(i),i-=r,i<n&&(i=n);return o}function h(t){for(var e=0,r=0;r<t.length;r++)e+=t[r];return e}function g(){function t(t){return Math.pow(t,2)}function o(e,r){return t(r.x-e.x)+t(r.y-e.y)}function a(t){f(),d=t.length,v=Math.abs(r.polygonArea(j.clip())),C=M*v,E.clear().totalArea(v);var e,n=0,i=w(t),o=!1;for(L(i,n);!(o||n>=W);)i=h(i,E.ratio()),n++,e=c(i),E.add(e),o=e<C,console.log("error %: "+Math.round(100*e*1e3/v)/1e3),L(i,n);return{polygons:i,iterationCount:n,convergenceRatio:e/v}}function h(t,e){var r;return g(t,e),r=t.map(function(t){return t.site.originalObject}),t=j(r),t.length<d&&console.log("at least 1 site has no area, which is not supposed to arise"),s(t,e),r=t.map(function(t){return t.site.originalObject}),t=j(r),t.length<d&&console.log("at least 1 site has no area, which is not supposed to arise"),t}function g(t,e){var n,i,o,a,h,g,s,l=[],u=.5;n=u*e,i=1-n;for(var c=0;c<d;c++)o=t[c],a=o.site.originalObject,h=r.polygonCentroid(o),g=h[0]-a.x,s=h[1]-a.y,g*=i,s*=i,a.x+=g,a.y+=s,l.push(a);m(l)}function s(t,e){var n,i,o,a,h,g,s=[],l=.1;n=l*e;for(var u=0;u<d;u++)i=t[u],o=i.site.originalObject,a=r.polygonArea(i),h=o.targetedArea/a,h=Math.max(h,1-l+n),h=Math.min(h,1+l-n),g=o.weight*h,g=Math.max(g,x),o.weight=g,s.push(o);m(s)}function l(t){var e,r,n,i,a,h,g,s=0;do{e=!1;for(var l=0;l<d;l++){r=t[l];for(var u=l+1;u<d;u++)if(n=t[u],r.weight>n.weight?(i=r,a=n):(i=n,a=r),h=o(r,n),h<i.weight-a.weight){g=h+a.weight/2,g=Math.max(g,x),i.weight=g,e=!0,s++;break}if(e)break}}while(e);s>0&&console.log("# fix: "+s)}function u(t){var e,r,n,i,a,h,g,s=0;do{e=!1;for(var l=0;l<d;l++){r=t[l];for(var u=l+1;u<d;u++)if(n=t[u],r.weight>n.weight?(i=r,a=n):(i=n,a=r),h=o(r,n),h<i.weight-a.weight){g=i.weight-a.weight-h,a.weight+=g+x,e=!0,s++;break}if(e)break}}while(e);s>0&&console.log("# fix: "+s)}function c(t){for(var e,n,i,o=0,a=0;a<d;a++)e=t[a],n=e.site.originalObject,i=r.polygonArea(e),o+=Math.abs(n.targetedArea-i);return o}function f(){switch(O){case 0:m=l;break;case 1:m=u;break;default:console.log("Variant of 'handleOverweighted' is unknown")}}function w(t){var e,r,n=t.reduce(function(t,e){return Math.max(t,N(e))},-(1/0)),i=n*k;return e=t.map(function(t,e){return{index:e,weight:Math.max(N(t),i),originalData:t}}),r=p(e),j(r)}function p(t){var n,i,o=t.reduce(function(t,e){return t+=e.weight},0),a=v/d,h=e.extent(j.clip().map(function(t){return t[0]})),g=e.extent(j.clip().map(function(t){return t[1]})),s=h[1]-h[0],l=g[1]-g[0],u=a/2;return t.map(function(t){for(n=h[0]+s*Math.random(),i=g[0]+l*Math.random();!r.polygonContains(j.clip(),[n,i]);)n=h[0]+s*Math.random(),i=g[0]+l*Math.random();return{index:t.index,targetedArea:v*t.weight/o,data:t,x:n,y:i,weight:u}})}var d,v,C,m,y=.01,A=50,b=.01,x=1,N=function(t){return t.weight},M=y,W=A,k=b,L=function(t,e){return!0},j=n.weightedVoronoi(),E=new i,O=1;return a.weight=function(t){return arguments.length?(N=t,a):N},a.convergenceRatio=function(t){return arguments.length?(M=t,a):M},a.maxIterationCount=function(t){return arguments.length?(W=t,a):W},a.minWeightRatio=function(t){return arguments.length?(k=t,a):k},a.tick=function(t){return arguments.length?(L=t,a):L},a.clip=function(t){return arguments.length?(j.clip(t),a):j.clip()},a}var s=10;i.prototype.reset=function(){return this.lastAreaError=NaN,this.lastGrowth=NaN,this.growthChanges=[],this.growthChangesLength=s,this.growthChangeWeights=a(this.growthChangesLength),this.growthChangeWeightsSum=h(this.growthChangeWeights),this.totalAvailableArea=NaN,this},i.prototype.clear=function(){return this.lastAreaError=NaN,this.lastGrowth=NaN,this.growthChanges=[],this},i.prototype.length=function(t){return arguments.length?(parseInt(t)>0?(this.growthChangesLength=Math.floor(parseInt(t)),this.growthChangeWeights=a(this.growthChangesLength),this.growthChangeWeightsSum=h(this.growthChangeWeights)):console.warn("FlickeringMitigation.length() accepts only positive integers; unable to handle "+t),this):this.growthChangesLength},i.prototype.totalArea=function(t){return arguments.length?(parseFloat(t)>0?this.totalAvailableArea=parseFloat(t):console.warn("FlickeringMitigation.totalArea() accepts only positive numbers; unable to handle "+t),this):this.totalAvailableArea},i.prototype.add=function(t){var e,r;return e=this.lastAreaError,this.lastAreaError=t,isNaN(e)||(r=this.lastGrowth,this.lastGrowth=o(this.lastAreaError,e)),isNaN(r)||this.growthChanges.unshift(this.lastGrowth!=r),this.growthChanges.length>this.growthChangesLength&&this.growthChanges.pop(),this},i.prototype.ratio=function(){var t,e=0;if(this.growthChanges.length<this.growthChangesLength)return 0;if(this.lastAreaError>this.totalAvailableArea/10)return 0;for(var r=0;r<this.growthChangesLength;r++)this.growthChanges[r]&&(e+=this.growthChangeWeights[r]);return t=e/this.growthChangeWeightsSum,t>0&&console.log("flickering mitigation ratio: "+Math.floor(1e3*t)/1e3),t},t.voronoiTreemap=g,Object.defineProperty(t,"__esModule",{value:!0})});