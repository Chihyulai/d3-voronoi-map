!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports,require("d3-array"),require("d3-polygon"),require("d3-weighted-voronoi")):"function"==typeof define&&define.amd?define(["exports","d3-array","d3-polygon","d3-weighted-voronoi"],i):i(t.d3=t.d3||{},t.d3,t.d3,t.d3)}(this,function(t,i,e,n){"use strict";function r(){this.history=[],this.directions=[],this.directionChanges=[],this.historyLength=10,this.directionLength=this.historyLength-1,this.directionChangeLength=this.directionLength-1,this.totalAvailableArea=NaN,this.initialIndexWeight=3,this.indexWeightDecrement=1}function o(t,i){return t>=i?1:-1}function h(){function t(t,i){return O(i.x-t.x)+O(i.y-t.y)}function o(t){l(),p=t.length,y=Math.abs(e.polygonArea(C.clip())),w=m*y,k.clear().totalArea(y);var i,n=0,r=d(t),o=!1;for(A(r,n);!(o||n>=b);)r=h(r,k.ratio()),n++,i=u(r),k.add(i),o=i<w,console.log("error %: "+Math.round(100*i*1e3/y)/1e3),A(r,n);return{polygons:r,iterationCount:n,convergenceRatio:i/y}}function h(t,i){var e;return a(t,i),e=t.map(function(t){return t.site.originalObject}),t=C(e),t.length<p&&console.log("at least 1 site has no area, which is not supposed to arise"),s(t,i),e=t.map(function(t){return t.site.originalObject}),t=C(e),t.length<p&&console.log("at least 1 site has no area, which is not supposed to arise"),t}function a(t,i){var n,r,o,h,a,s,c,g=[],u=.5;n=u*i,r=1-n;for(var l=0;l<p;l++)o=t[l],h=o.site.originalObject,a=e.polygonCentroid(o),s=a[0]-h.x,c=a[1]-h.y,s*=r,c*=r,h.x+=s,h.y+=c,g.push(h);v(g)}function s(t,i){var n,r,o,h,a,s,c=[],g=.1;n=g*i;for(var u=0;u<p;u++)r=t[u],o=r.site.originalObject,h=e.polygonArea(r),a=o.targetedArea/h,a=Math.max(a,1-g+n),a=Math.min(a,1+g-n),s=o.weight*a,s=Math.max(s,M),o.weight=s,c.push(o);v(c)}function c(i){var e,n,r,o,h,a,s,c=0;do{e=!1;for(var g=0;g<p;g++){n=i[g];for(var u=g+1;u<p;u++)if(r=i[u],n.weight>r.weight?(o=n,h=r):(o=r,h=n),a=t(n,r),a<o.weight-h.weight){s=a+h.weight/2,s=Math.max(s,M),o.weight=s,e=!0,c++;break}if(e)break}}while(e);c>0&&console.log("# fix: "+c)}function g(i){var e,n,r,o,h,a,s,c=0;do{e=!1;for(var g=0;g<p;g++){n=i[g];for(var u=g+1;u<p;u++)if(r=i[u],n.weight>r.weight?(o=n,h=r):(o=r,h=n),a=t(n,r),a<o.weight-h.weight){s=o.weight-h.weight-a,h.weight+=s+M,e=!0,c++;break}if(e)break}}while(e);c>0&&console.log("# fix: "+c)}function u(t){for(var i,n,r,o=0,h=0;h<p;h++)i=t[h],n=i.site.originalObject,r=e.polygonArea(i),o+=Math.abs(n.targetedArea-r);return o}function l(){switch(j){case 0:v=c;break;case 1:v=g;break;default:console.log("Variant of 'handleOverweighted' is unknown")}}function d(t){var i,e,n=t.reduce(function(t,i){return Math.max(t,x(i))},-(1/0)),r=n*L;return i=t.map(function(t,i){return{index:i,weight:Math.max(x(t),r),originalData:t}}),e=f(i),C(e)}function f(t){var n,r,o=t.reduce(function(t,i){return t+=i.weight},0),h=y/p,a=i.extent(C.clip().map(function(t){return t[0]})),s=i.extent(C.clip().map(function(t){return t[1]})),c=a[1]-a[0],g=s[1]-s[0],u=h/2;return t.map(function(t){for(n=a[0]+c*Math.random(),r=s[0]+g*Math.random();!e.polygonContains(C.clip(),[n,r]);)n=a[0]+c*Math.random(),r=s[0]+g*Math.random();return{index:t.index,targetedArea:y*t.weight/o,data:t,x:n,y:r,weight:u}})}var p,y,w,v,x=function(t){return t.weight},m=.01,b=50,L=.01,A=function(t,i){return!0},M=1,C=n.weightedVoronoi(),k=new r,j=1,O=(Math.sqrt,function(t){return Math.pow(t,2)});return o.weight=function(t){return arguments.length?(x=t,o):x},o.convergenceRatio=function(t){return arguments.length?(m=t,o):m},o.maxIterationCount=function(t){return arguments.length?(b=t,o):b},o.minWeightRatio=function(t){return arguments.length?(L=t,o):L},o.tick=function(t){return arguments.length?(A=t,o):A},o.clip=function(t){return arguments.length?(C.clip(t),o):C.clip()},o}r.prototype.reset=function(){return this.history=[],this.directions=[],this.directionChanges=[],this.historyLength=10,this.directionLength=this.historyLength-1,this.directionChangeLength=this.directionLength-1,this.totalAvailableArea=NaN,this},r.prototype.clear=function(){return this.history=[],this.directions=[],this.directionChanges=[],this},r.prototype.length=function(t){return arguments.length?(this.historyLength=t,this.directionLength=this.historyLength-1,this.directionChangeLength=this.directionLength-1,this):this.historyLength},r.prototype.totalArea=function(t){return arguments.length?(this.totalAvailableArea=t,this):this.totalAvailableArea},r.prototype.add=function(t){return this.history.unshift(t),this.history.length>1&&this.directions.unshift(o(this.history[0],this.history[1])),this.directions.length>1&&this.directionChanges.unshift(this.directions[0]!=this.directions[1]),this.history.length>this.historyLength&&(this.history.pop(),this.directions.pop(),this.directionChanges.pop()),this},r.prototype.ratio=function(){var t,i=0,e=0,n=this.initialIndexWeight;if(this.history.length<this.historyLength)return 0;if(this.history[0]>this.totalAvailableArea/10)return 0;for(var r=0;r<this.directionChangeLength;r++)this.directionChanges[r]&&(i+=n),e+=n,n-=this.indexWeightDecrement,n<1&&(n=1);return t=i/e,t>0&&console.log("flickering mitigation ratio: "+Math.floor(1e3*t)/1e3),t},t.voronoiTreemap=h,Object.defineProperty(t,"__esModule",{value:!0})});