!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3-polygon"),require("d3-weighted-voronoi")):"function"==typeof define&&define.amd?define(["exports","d3-polygon","d3-weighted-voronoi"],e):e(t.d3=t.d3||{},t.d3,t.d3)}(this,function(t,e,n){"use strict";function r(){this.growthChangesLength=f,this.totalAvailableArea=NaN,this.lastAreaError=NaN,this.lastGrowth=NaN,this.growthChanges=[],this.growthChangeWeights=o(this.growthChangesLength),this.growthChangeWeightsSum=a(this.growthChangeWeights)}function i(t,e){return t>=e?1:-1}function o(t){for(var e=3,n=1,r=1,i=e,o=[],a=0;a<t;a++)o.push(i),i-=n,i<r&&(i=r);return o}function a(t){for(var e=0,n=0;n<t.length;n++)e+=t[n];return e}function h(t,n,r,i){var o,a,h=i.clip(),g=i.extent(),s=g[0][0],l=g[1][0],u=g[0][1],c=g[1][1],f=l-s,w=c-u;for(o=s+f*Math.random(),a=u+w*Math.random();!e.polygonContains(h,[o,a]);)o=s+f*Math.random(),a=u+w*Math.random();return[o,a]}function g(t,n,r,i){var o=r.length;return w!==i.clip()&&(w=i.clip(),p=e.polygonCentroid(w),d=s(p,w),v=d/2),[p[0]+Math.cos(2*n*Math.PI/o)*v+.001*Math.random(),p[1]+Math.sin(2*n*Math.PI/o)*v+.001*Math.random()]}function s(t,e){for(var n,r=1/0,i=0,o=e[e.length-1],a=e[i];i<e.length;)n=l(t,o,a),n<r&&(r=n),i++,o=a,a=e[i];return r}function l(t,e,n){var r=t[0],i=t[1],o=e[0],a=e[1],h=n[0],g=n[1],s=r-o,l=i-a,u=h-o,c=g-a,f=s*u+l*c,w=u*u+c*c,p=-1;0!=w&&(p=f/w);var d,v;p<0?(d=o,v=a):p>1?(d=h,v=g):(d=o+p*u,v=a+p*c);var C=r-d,y=i-v;return Math.sqrt(C*C+y*y)}function u(t,n,r,i){var o=r.length,a=e.polygonArea(i.clip());return a/o/2}function c(){function t(t){return Math.pow(t,2)}function i(e,n){return t(n.x-e.x)+t(n.y-e.y)}function o(t){p(),C=t.length,y=Math.abs(e.polygonArea(F.clip())),m=j*y,S.clear().totalArea(y);var n,r=0,i=d(t),o=!1;for(I(i,r);!(o||r>=E);)i=a(i,S.ratio()),r++,n=w(i),S.add(n),o=n<m,I(i,r);return{polygons:i,iterationCount:r,convergenceRatio:n/y}}function a(t,e){var n;return s(t,e),n=t.map(function(t){return t.site.originalObject}),t=F(n),t.length<C&&console.log("at least 1 site has no area, which is not supposed to arise"),l(t,e),n=t.map(function(t){return t.site.originalObject}),t=F(n),t.length<C&&console.log("at least 1 site has no area, which is not supposed to arise"),t}function s(t,n){var r,i,o,a,h,g,s,l=[],u=.5;r=u*n,i=1-r;for(var c=0;c<C;c++)o=t[c],a=o.site.originalObject,h=e.polygonCentroid(o),g=h[0]-a.x,s=h[1]-a.y,g*=i,s*=i,a.x+=g,a.y+=s,l.push(a);A(l)}function l(t,n){var r,i,o,a,h,g,s=[],l=.1;r=l*n;for(var u=0;u<C;u++)i=t[u],o=i.site.originalObject,a=e.polygonArea(i),h=o.targetedArea/a,h=Math.max(h,1-l+r),h=Math.min(h,1+l-r),g=o.weight*h,g=Math.max(g,k),o.weight=g,s.push(o);A(s)}function c(t){var e,n,r,o,a,h,g,s=0;do{e=!1;for(var l=0;l<C;l++){n=t[l];for(var u=l+1;u<C;u++)if(r=t[u],n.weight>r.weight?(o=n,a=r):(o=r,a=n),h=i(n,r),h<o.weight-a.weight){g=h+a.weight/2,g=Math.max(g,k),o.weight=g,e=!0,s++;break}if(e)break}}while(e)}function f(t){var e,n,r,o,a,h,g,s=0;do{e=!1;for(var l=0;l<C;l++){n=t[l];for(var u=l+1;u<C;u++)if(r=t[u],n.weight>r.weight?(o=n,a=r):(o=r,a=n),h=i(n,r),h<o.weight-a.weight){g=o.weight-a.weight-h,a.weight+=g+k,e=!0,s++;break}if(e)break}}while(e)}function w(t){for(var n,r,i,o=0,a=0;a<C;a++)n=t[a],r=n.site.originalObject,i=e.polygonArea(n),o+=Math.abs(r.targetedArea-i);return o}function p(){switch(q){case 0:A=c;break;case 1:A=f;break;default:console.log("Variant of 'handleOverweighted' is unknown")}}function d(t){var e,n,r=t.reduce(function(t,e){return Math.max(t,L(e))},-(1/0)),i=r*O;return e=t.map(function(t,e,n){return{index:e,weight:Math.max(L(t),i),initialPosition:G(t,e,n,o),initialWeight:P(t,e,n,o),originalData:t}}),n=v(e),F(n)}function v(t){var n,r=t.reduce(function(t,e){return t+=e.weight},0);return t.map(function(t,i,a){return n=t.initialPosition,e.polygonContains(F.clip(),n)||(n=h(t,i,a,o)),{index:t.index,targetedArea:y*t.weight/r,data:t,x:n[0],y:n[1],weight:t.initialWeight}})}var C,y,m,A,M=.01,b=50,x=.01,N=h,W=u,k=1,L=function(t){return t.weight},j=M,E=b,O=x,G=N,P=W,I=function(t,e){return!0},F=n.weightedVoronoi(),S=new r,q=1;return o.weight=function(t){return arguments.length?(L=t,o):L},o.convergenceRatio=function(t){return arguments.length?(j=t,o):j},o.maxIterationCount=function(t){return arguments.length?(E=t,o):E},o.minWeightRatio=function(t){return arguments.length?(O=t,o):O},o.tick=function(t){return arguments.length?(I=t,o):I},o.clip=function(t){return arguments.length?(F.clip(t),o):F.clip()},o.extent=function(t){return arguments.length?(F.extent(t),o):F.extent()},o.size=function(t){return arguments.length?(F.size(t),o):F.size()},o.initialPosition=function(t){return arguments.length?(G="random"==t?h:"pie"==t?g:t,o):G},o.initialWeight=function(t){return arguments.length?(P=t,o):P},o}var f=10;r.prototype.reset=function(){return this.lastAreaError=NaN,this.lastGrowth=NaN,this.growthChanges=[],this.growthChangesLength=f,this.growthChangeWeights=o(this.growthChangesLength),this.growthChangeWeightsSum=a(this.growthChangeWeights),this.totalAvailableArea=NaN,this},r.prototype.clear=function(){return this.lastAreaError=NaN,this.lastGrowth=NaN,this.growthChanges=[],this},r.prototype.length=function(t){return arguments.length?(parseInt(t)>0?(this.growthChangesLength=Math.floor(parseInt(t)),this.growthChangeWeights=o(this.growthChangesLength),this.growthChangeWeightsSum=a(this.growthChangeWeights)):console.warn("FlickeringMitigation.length() accepts only positive integers; unable to handle "+t),this):this.growthChangesLength},r.prototype.totalArea=function(t){return arguments.length?(parseFloat(t)>0?this.totalAvailableArea=parseFloat(t):console.warn("FlickeringMitigation.totalArea() accepts only positive numbers; unable to handle "+t),this):this.totalAvailableArea},r.prototype.add=function(t){var e,n;return e=this.lastAreaError,this.lastAreaError=t,isNaN(e)||(n=this.lastGrowth,this.lastGrowth=i(this.lastAreaError,e)),isNaN(n)||this.growthChanges.unshift(this.lastGrowth!=n),this.growthChanges.length>this.growthChangesLength&&this.growthChanges.pop(),this},r.prototype.ratio=function(){var t,e=0;if(this.growthChanges.length<this.growthChangesLength)return 0;if(this.lastAreaError>this.totalAvailableArea/10)return 0;for(var n=0;n<this.growthChangesLength;n++)this.growthChanges[n]&&(e+=this.growthChangeWeights[n]);return t=e/this.growthChangeWeightsSum,t>0&&console.log("flickering mitigation ratio: "+Math.floor(1e3*t)/1e3),t};var w,p,d,v;t.voronoiMap=c,Object.defineProperty(t,"__esModule",{value:!0})});