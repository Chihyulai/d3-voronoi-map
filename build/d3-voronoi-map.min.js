!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3-array"),require("d3-polygon"),require("d3-weighted-voronoi")):"function"==typeof define&&define.amd?define(["exports","d3-array","d3-polygon","d3-weighted-voronoi"],e):e(t.d3=t.d3||{},t.d3,t.d3,t.d3)}(this,function(t,e,n,r){"use strict";function o(){this.growthChangesLength=l,this.totalAvailableArea=NaN,this.lastAreaError=NaN,this.lastGrowth=NaN,this.growthChanges=[],this.growthChangeWeights=h(this.growthChangesLength),this.growthChangeWeightsSum=g(this.growthChangeWeights)}function a(t,e){return t>=e?1:-1}function h(t){for(var e=3,n=1,r=1,i=e,o=[],a=0;a<t;a++)o.push(i),i-=n,i<r&&(i=r);return o}function g(t){for(var e=0,n=0;n<t.length;n++)e+=t[n];return e}function s(){function t(t){return Math.pow(t,2)}function a(e,n){return t(n.x-e.x)+t(n.y-e.y)}function h(t){w(),C=t.length,m=Math.abs(n.polygonArea(F.clip())),y=L*m,P.clear().totalArea(m);var e,r=0,i=p(t),o=!1;for(G(i,r);!(o||r>=j);)i=g(i,P.ratio()),r++,e=f(i),P.add(e),o=e<y,console.log("error %: "+Math.round(100*e*1e3/m)/1e3),G(i,r);return{polygons:i,iterationCount:r,convergenceRatio:e/m}}function g(t,e){var n;return s(t,e),n=t.map(function(t){return t.site.originalObject}),t=F(n),t.length<C&&console.log("at least 1 site has no area, which is not supposed to arise"),l(t,e),n=t.map(function(t){return t.site.originalObject}),t=F(n),t.length<C&&console.log("at least 1 site has no area, which is not supposed to arise"),t}function s(t,e){var r,i,o,a,h,g,s,l=[],u=.5;r=u*e,i=1-r;for(var c=0;c<C;c++)o=t[c],a=o.site.originalObject,h=n.polygonCentroid(o),g=h[0]-a.x,s=h[1]-a.y,g*=i,s*=i,a.x+=g,a.y+=s,l.push(a);A(l)}function l(t,e){var r,i,o,a,h,g,s=[],l=.1;r=l*e;for(var u=0;u<C;u++)i=t[u],o=i.site.originalObject,a=n.polygonArea(i),h=o.targetedArea/a,h=Math.max(h,1-l+r),h=Math.min(h,1+l-r),g=o.weight*h,g=Math.max(g,W),o.weight=g,s.push(o);A(s)}function u(t){var e,n,r,i,o,h,g,s=0;do{e=!1;for(var l=0;l<C;l++){n=t[l];for(var u=l+1;u<C;u++)if(r=t[u],n.weight>r.weight?(i=n,o=r):(i=r,o=n),h=a(n,r),h<i.weight-o.weight){g=h+o.weight/2,g=Math.max(g,W),i.weight=g,e=!0,s++;break}if(e)break}}while(e);s>0&&console.log("# fix: "+s)}function c(t){var e,n,r,i,o,h,g,s=0;do{e=!1;for(var l=0;l<C;l++){n=t[l];for(var u=l+1;u<C;u++)if(r=t[u],n.weight>r.weight?(i=n,o=r):(i=r,o=n),h=a(n,r),h<i.weight-o.weight){g=i.weight-o.weight-h,o.weight+=g+W,e=!0,s++;break}if(e)break}}while(e);s>0&&console.log("# fix: "+s)}function f(t){for(var e,r,i,o=0,a=0;a<C;a++)e=t[a],r=e.site.originalObject,i=n.polygonArea(e),o+=Math.abs(r.targetedArea-i);return o}function w(){switch(S){case 0:A=u;break;case 1:A=c;break;default:console.log("Variant of 'handleOverweighted' is unknown")}}function p(t){var e,n,r=t.reduce(function(t,e){return Math.max(t,k(e))},-(1/0)),i=r*E;return e=t.map(function(t,e){return{index:e,weight:Math.max(k(t),i),initPlacement:O(t,e,F.clip()),originalData:t}}),n=d(e),F(n)}function d(t){var e,r=t.reduce(function(t,e){return t+=e.weight},0),o=m/C,a=o/2;return t.map(function(t){return e=t.initPlacement,n.polygonContains(F.clip(),e)||(e=v(t,i,F.clip())),{index:t.index,targetedArea:m*t.weight/r,data:t,x:e[0],y:e[1],weight:a}})}function v(t,r,i){var o,a,h=e.extent(i.map(function(t){return t[0]})),g=e.extent(i.map(function(t){return t[1]})),s=h[1]-h[0],l=g[1]-g[0];for(o=h[0]+s*Math.random(),a=g[0]+l*Math.random();!n.polygonContains(i,[o,a]);)o=h[0]+s*Math.random(),a=g[0]+l*Math.random();return[o,a]}var C,m,y,A,b=.01,x=50,M=.01,N=v,W=1,k=function(t){return t.weight},L=b,j=x,E=M,O=N,G=function(t,e){return!0},F=r.weightedVoronoi(),P=new o,S=1;return h.weight=function(t){return arguments.length?(k=t,h):k},h.convergenceRatio=function(t){return arguments.length?(L=t,h):L},h.maxIterationCount=function(t){return arguments.length?(j=t,h):j},h.minWeightRatio=function(t){return arguments.length?(E=t,h):E},h.tick=function(t){return arguments.length?(G=t,h):G},h.clip=function(t){return arguments.length?(F.clip(t),h):F.clip()},h.initPlacement=function(t){return arguments.length?(O=t,h):O},h}var l=10;o.prototype.reset=function(){return this.lastAreaError=NaN,this.lastGrowth=NaN,this.growthChanges=[],this.growthChangesLength=l,this.growthChangeWeights=h(this.growthChangesLength),this.growthChangeWeightsSum=g(this.growthChangeWeights),this.totalAvailableArea=NaN,this},o.prototype.clear=function(){return this.lastAreaError=NaN,this.lastGrowth=NaN,this.growthChanges=[],this},o.prototype.length=function(t){return arguments.length?(parseInt(t)>0?(this.growthChangesLength=Math.floor(parseInt(t)),this.growthChangeWeights=h(this.growthChangesLength),this.growthChangeWeightsSum=g(this.growthChangeWeights)):console.warn("FlickeringMitigation.length() accepts only positive integers; unable to handle "+t),this):this.growthChangesLength},o.prototype.totalArea=function(t){return arguments.length?(parseFloat(t)>0?this.totalAvailableArea=parseFloat(t):console.warn("FlickeringMitigation.totalArea() accepts only positive numbers; unable to handle "+t),this):this.totalAvailableArea},o.prototype.add=function(t){var e,n;return e=this.lastAreaError,this.lastAreaError=t,isNaN(e)||(n=this.lastGrowth,this.lastGrowth=a(this.lastAreaError,e)),isNaN(n)||this.growthChanges.unshift(this.lastGrowth!=n),this.growthChanges.length>this.growthChangesLength&&this.growthChanges.pop(),this},o.prototype.ratio=function(){var t,e=0;if(this.growthChanges.length<this.growthChangesLength)return 0;if(this.lastAreaError>this.totalAvailableArea/10)return 0;for(var n=0;n<this.growthChangesLength;n++)this.growthChanges[n]&&(e+=this.growthChangeWeights[n]);return t=e/this.growthChangeWeightsSum,t>0&&console.log("flickering mitigation ratio: "+Math.floor(1e3*t)/1e3),t},t.voronoiMap=s,Object.defineProperty(t,"__esModule",{value:!0})});