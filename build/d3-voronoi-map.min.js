!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3-polygon"),require("d3-timer"),require("d3-dispatch"),require("d3-weighted-voronoi")):"function"==typeof define&&define.amd?define(["exports","d3-polygon","d3-timer","d3-dispatch","d3-weighted-voronoi"],e):e(t.d3=t.d3||{},t.d3,t.d3,t.d3,t.d3)}(this,function(t,e,n,i,r){"use strict";function o(){this.growthChangesLength=c,this.totalAvailableArea=NaN,this.lastAreaError=NaN,this.lastGrowth=NaN,this.growthChanges=[],this.growthChangeWeights=h(this.growthChangesLength),this.growthChangeWeightsSum=s(this.growthChangeWeights)}function a(t,e){return t>=e?1:-1}function h(t){for(var e=3,n=1,i=1,r=e,o=[],a=0;a<t;a++)o.push(r),r-=n,r<i&&(r=i);return o}function s(t){for(var e=0,n=0;n<t.length;n++)e+=t[n];return e}function g(t,n,i,r){var o,a,h=r.clip(),s=r.extent(),g=s[0][0],l=s[1][0],u=s[0][1],c=s[1][1],f=l-g,w=c-u;for(o=g+f*Math.random(),a=u+w*Math.random();!e.polygonContains(h,[o,a]);)o=g+f*Math.random(),a=u+w*Math.random();return[o,a]}function l(t,n,i,r){var o=i.length,a=e.polygonArea(r.clip());return a/o/2}function u(t){function a(t){return Math.pow(t,2)}function h(t,e){return a(e.x-t.x)+a(e.y-t.y)}function s(){u(),Q.call("tick",E),j&&(K.stop(),Q.call("end",E))}function u(){j||(W=f(W,J.ratio()),x++,k=C(W),J.add(k),L=k<M,j=L||x>=_)}function c(){m(),b=t.length,N=Math.abs(e.polygonArea(H.clip())),M=V*N,J.clear().totalArea(N),x=0,L=!1,W=y(t),j=!1}function f(t,e){var n;return w(t,e),n=t.map(function(t){return t.site.originalObject}),t=H(n),t.length<b&&console.log("at least 1 site has no area, which is not supposed to arise"),p(t,e),n=t.map(function(t){return t.site.originalObject}),t=H(n),t.length<b&&console.log("at least 1 site has no area, which is not supposed to arise"),t}function w(t,n){var i,r,o,a,h,s,g,l=[],u=.5;i=u*n,r=1-i;for(var c=0;c<b;c++)o=t[c],a=o.site.originalObject,h=e.polygonCentroid(o),s=h[0]-a.x,g=h[1]-a.y,s*=r,g*=r,a.x+=s,a.y+=g,l.push(a);O(l)}function p(t,n){var i,r,o,a,h,s,g=[],l=.1;i=l*n;for(var u=0;u<b;u++)r=t[u],o=r.site.originalObject,a=e.polygonArea(r),h=o.targetedArea/a,h=Math.max(h,1-l+i),h=Math.min(h,1+l-i),s=o.weight*h,s=Math.max(s,I),o.weight=s,g.push(o);O(g)}function d(t){var e,n,i,r,o,a,s,g=0;do{e=!1;for(var l=0;l<b;l++){n=t[l];for(var u=l+1;u<b;u++)if(i=t[u],n.weight>i.weight?(r=n,o=i):(r=i,o=n),a=h(n,i),a<r.weight-o.weight){s=a+o.weight/2,s=Math.max(s,I),r.weight=s,e=!0,g++;break}if(e)break}}while(e)}function v(t){var e,n,i,r,o,a,s,g=0;do{e=!1;for(var l=0;l<b;l++){n=t[l];for(var u=l+1;u<b;u++)if(i=t[u],n.weight>i.weight?(r=n,o=i):(r=i,o=n),a=h(n,i),a<r.weight-o.weight){s=r.weight-o.weight-a,o.weight+=s+I,e=!0,g++;break}if(e)break}}while(e)}function C(t){for(var n,i,r,o=0,a=0;a<b;a++)n=t[a],i=n.site.originalObject,r=e.polygonArea(n),o+=Math.abs(i.targetedArea-r);return o}function m(){switch(T){case 0:O=d;break;case 1:O=v;break;default:console.log("Variant of 'handleOverweighted' is unknown")}}function y(t){var e,n,i=t.reduce(function(t,e){return Math.max(t,R(e))},-(1/0)),r=i*D;return e=t.map(function(t,e,n){return{index:e,weight:Math.max(R(t),r),initialPosition:z(t,e,n,H),initialWeight:B(t,e,n,H),originalData:t}}),n=A(e),H(n)}function A(t){var n,i=t.reduce(function(t,e){return t+=e.weight},0);return t.map(function(t,r,o){return n=t.initialPosition,e.polygonContains(H.clip(),n)||(n=g(t,r,o,H)),{index:t.index,targetedArea:N*t.weight/i,data:t,x:n[0],y:n[1],weight:t.initialWeight}})}var b,N,M,x,W,k,L,j,E,O,G=.01,S=50,q=.01,F=g,P=l,I=1,R=function(t){return t.weight},V=G,_=S,D=q,z=F,B=P,H=r.weightedVoronoi(),J=new o,K=n.timer(s),Q=i.dispatch("tick","end"),T=1;return c(),E={tick:u,restart:function(){return K.restart(s),E},stop:function(){return K.stop(),E},weight:function(t){return arguments.length?(R=t,c(),E):R},convergenceRatio:function(t){return arguments.length?(V=t,c(),E):V},maxIterationCount:function(t){return arguments.length?(_=t,E):_},minWeightRatio:function(t){return arguments.length?(D=t,c(),E):D},clip:function(t){return arguments.length?(H.clip(t),c(),E):H.clip()},initialPosition:function(t){return arguments.length?(z=t,c(),E):z},initialWeight:function(t){return arguments.length?(B=t,c(),E):B},state:function(){return{ended:j,iterationCount:x,convergenceRatio:k/N,polygons:W}},on:function(t,e){return 1===arguments.length?Q.on(t):(Q.on(t,e),E)}}}var c=10;o.prototype.reset=function(){return this.lastAreaError=NaN,this.lastGrowth=NaN,this.growthChanges=[],this.growthChangesLength=c,this.growthChangeWeights=h(this.growthChangesLength),this.growthChangeWeightsSum=s(this.growthChangeWeights),this.totalAvailableArea=NaN,this},o.prototype.clear=function(){return this.lastAreaError=NaN,this.lastGrowth=NaN,this.growthChanges=[],this},o.prototype.length=function(t){return arguments.length?(parseInt(t)>0?(this.growthChangesLength=Math.floor(parseInt(t)),this.growthChangeWeights=h(this.growthChangesLength),this.growthChangeWeightsSum=s(this.growthChangeWeights)):console.warn("FlickeringMitigation.length() accepts only positive integers; unable to handle "+t),this):this.growthChangesLength},o.prototype.totalArea=function(t){return arguments.length?(parseFloat(t)>0?this.totalAvailableArea=parseFloat(t):console.warn("FlickeringMitigation.totalArea() accepts only positive numbers; unable to handle "+t),this):this.totalAvailableArea},o.prototype.add=function(t){var e,n;return e=this.lastAreaError,this.lastAreaError=t,isNaN(e)||(n=this.lastGrowth,this.lastGrowth=a(this.lastAreaError,e)),isNaN(n)||this.growthChanges.unshift(this.lastGrowth!=n),this.growthChanges.length>this.growthChangesLength&&this.growthChanges.pop(),this},o.prototype.ratio=function(){var t,e=0;if(this.growthChanges.length<this.growthChangesLength)return 0;if(this.lastAreaError>this.totalAvailableArea/10)return 0;for(var n=0;n<this.growthChangesLength;n++)this.growthChanges[n]&&(e+=this.growthChangeWeights[n]);return t=e/this.growthChangeWeightsSum,t>0&&console.log("flickering mitigation ratio: "+Math.floor(1e3*t)/1e3),t},t.voronoiMapSimulation=u,Object.defineProperty(t,"__esModule",{value:!0})});