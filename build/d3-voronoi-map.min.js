!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("d3-polygon"),require("d3-timer"),require("d3-dispatch"),require("d3-weighted-voronoi")):"function"==typeof define&&define.amd?define(["exports","d3-polygon","d3-timer","d3-dispatch","d3-weighted-voronoi"],n):n(t.d3=t.d3||{},t.d3,t.d3,t.d3,t.d3)}(this,function(t,n,e,i,r){"use strict";function o(){this.growthChangesLength=f,this.totalAvailableArea=NaN,this.lastAreaError=NaN,this.lastGrowth=NaN,this.growthChanges=[],this.growthChangeWeights=h(this.growthChangesLength),this.growthChangeWeightsSum=s(this.growthChangeWeights)}function a(t,n){return t>=n?1:-1}function h(t){for(var n=3,e=1,i=1,r=n,o=[],a=0;a<t;a++)o.push(r),r-=e,r<i&&(r=i);return o}function s(t){for(var n=0,e=0;e<t.length;e++)n+=t[e];return n}function g(){function t(t,a,s,l){var c,f,p=!1;for(i!==l.clip()&&(i=l.clip(),r=l.extent(),p=!0),p&&e(),c=o+g*Math.random(),f=h+u*Math.random();!n.polygonContains(i,[c,f]);)c=o+g*Math.random(),f=h+u*Math.random();return[c,f]}function e(){o=r[0][0],a=r[1][0],h=r[0][1],s=r[1][1],g=a-o,u=s-h}var i,r,o,a,h,s,g,u;return t}function u(){function t(t,n,i,r){var h=!1;return o!==r.clip()&&(o=r.clip(),h|=!0),a!==i&&(a=i,h|=!0),h&&e(),[s[0]+Math.cos(l+n*u)*g+.001*Math.random(),s[1]+Math.sin(l+n*u)*g+.001*Math.random()]}function e(){s=n.polygonCentroid(o),g=i(s,o)/2,h=a.length,u=2*Math.PI/h}function i(t,n){for(var e,i=1/0,o=0,a=n[n.length-1],h=n[o];o<n.length;)e=r(t,a,h),e<i&&(i=e),o++,a=h,h=n[o];return i}function r(t,n,e){var i=t[0],r=t[1],o=n[0],a=n[1],h=e[0],s=e[1],g=i-o,u=r-a,l=h-o,c=s-a,f=g*l+u*c,p=l*l+c*c,w=-1;0!=p&&(w=f/p);var d,v;w<0?(d=o,v=a):w>1?(d=h,v=s):(d=o+w*l,v=a+w*c);var C=i-d,m=r-v;return Math.sqrt(C*C+m*m)}var o,a,h,s,g,u,l=0;return t.startAngle=function(n){return arguments.length?(l=n,t):l},t}function l(){function t(t,n,o,a){var s=!1;return i!==a.clip()&&(i=a.clip(),s|=!0),r!==o&&(r=o,s|=!0),s&&e(),h}function e(){o=r.length,a=n.polygonArea(i),h=a/o/2}var i,r,o,a,h;return t}function c(t){function a(t){return Math.pow(t,2)}function h(t,n){return a(n.x-t.x)+a(n.y-t.y)}function s(){u(),Q.call("tick",j),P&&(K.stop(),Q.call("end",j))}function u(){P||(W=w(W,J.ratio()),N++,k=y(W),J.add(k),L=k<x,P=L||N>=V)}function c(){A(),M=t.length,b=Math.abs(n.polygonArea(H.clip())),x=z*b,J.clear().totalArea(b),N=0,L=!1,W=f(t,j),P=!1}function f(t,n){var e,i,r=t.reduce(function(t,n){return Math.max(t,R(n))},-(1/0)),o=r*_;return e=t.map(function(t,e,i){return{index:e,weight:Math.max(R(t),o),initialPosition:D(t,e,i,n),initialWeight:B(t,e,i,n),originalData:t}}),i=p(e,n),H(i)}function p(t,e){var i,r=t.reduce(function(t,n){return t+=n.weight},0);return t.map(function(t,o,a){return i=t.initialPosition,n.polygonContains(H.clip(),i)||(i=q(t,o,a,e)),{index:t.index,targetedArea:b*t.weight/r,data:t,x:i[0],y:i[1],weight:t.initialWeight}})}function w(t,n){var e;return d(t,n),e=t.map(function(t){return t.site.originalObject}),t=H(e),t.length<M&&console.log("at least 1 site has no area, which is not supposed to arise"),v(t,n),e=t.map(function(t){return t.site.originalObject}),t=H(e),t.length<M&&console.log("at least 1 site has no area, which is not supposed to arise"),t}function d(t,e){var i,r,o,a,h,s,g,u=[],l=.5;i=l*e,r=1-i;for(var c=0;c<M;c++)o=t[c],a=o.site.originalObject,h=n.polygonCentroid(o),s=h[0]-a.x,g=h[1]-a.y,s*=r,g*=r,a.x+=s,a.y+=g,u.push(a);E(u)}function v(t,e){var i,r,o,a,h,s,g=[],u=.1;i=u*e;for(var l=0;l<M;l++)r=t[l],o=r.site.originalObject,a=n.polygonArea(r),h=o.targetedArea/a,h=Math.max(h,1-u+i),h=Math.min(h,1+u-i),s=o.weight*h,s=Math.max(s,F),o.weight=s,g.push(o);E(g)}function C(t){var n,e,i,r,o,a,s,g=0;do{n=!1;for(var u=0;u<M;u++){e=t[u];for(var l=u+1;l<M;l++)if(i=t[l],e.weight>i.weight?(r=e,o=i):(r=i,o=e),a=h(e,i),a<r.weight-o.weight){s=a+o.weight/2,s=Math.max(s,F),r.weight=s,n=!0,g++;break}if(n)break}}while(n)}function m(t){var n,e,i,r,o,a,s,g=0;do{n=!1;for(var u=0;u<M;u++){e=t[u];for(var l=u+1;l<M;l++)if(i=t[l],e.weight>i.weight?(r=e,o=i):(r=i,o=e),a=h(e,i),a<r.weight-o.weight){s=r.weight-o.weight-a,o.weight+=s+F,n=!0,g++;break}if(n)break}}while(n)}function y(t){for(var e,i,r,o=0,a=0;a<M;a++)e=t[a],i=e.site.originalObject,r=n.polygonArea(e),o+=Math.abs(i.targetedArea-r);return o}function A(){switch(T){case 0:E=C;break;case 1:E=m;break;default:console.log("Variant of 'handleOverweighted' is unknown")}}var M,b,x,N,W,k,L,P,j,E,O=.01,G=50,I=.01,q=g(),S=l(),F=1,R=function(t){return t.weight},z=O,V=G,_=I,D=q,B=S,H=r.weightedVoronoi(),J=new o,K=e.timer(s),Q=i.dispatch("tick","end"),T=1;return j={tick:u,restart:function(){return K.restart(s),j},stop:function(){return K.stop(),j},weight:function(t){return arguments.length?(R=t,c(),j):R},convergenceRatio:function(t){return arguments.length?(z=t,c(),j):z},maxIterationCount:function(t){return arguments.length?(V=t,j):V},minWeightRatio:function(t){return arguments.length?(_=t,c(),j):_},clip:function(t){return arguments.length?(H.clip(t),c(),j):H.clip()},extent:function(t){return arguments.length?(H.extent(t),c(),j):H.extent()},size:function(t){return arguments.length?(H.size(t),c(),j):H.size()},initialPosition:function(t){return arguments.length?(D=t,c(),j):D},initialWeight:function(t){return arguments.length?(B=t,c(),j):B},state:function(){return{ended:P,iterationCount:N,convergenceRatio:k/b,polygons:W}},on:function(t,n){return 1===arguments.length?Q.on(t):(Q.on(t,n),j)}},c(),j}var f=10;o.prototype.reset=function(){return this.lastAreaError=NaN,this.lastGrowth=NaN,this.growthChanges=[],this.growthChangesLength=f,this.growthChangeWeights=h(this.growthChangesLength),this.growthChangeWeightsSum=s(this.growthChangeWeights),this.totalAvailableArea=NaN,this},o.prototype.clear=function(){return this.lastAreaError=NaN,this.lastGrowth=NaN,this.growthChanges=[],this},o.prototype.length=function(t){return arguments.length?(parseInt(t)>0?(this.growthChangesLength=Math.floor(parseInt(t)),this.growthChangeWeights=h(this.growthChangesLength),this.growthChangeWeightsSum=s(this.growthChangeWeights)):console.warn("FlickeringMitigation.length() accepts only positive integers; unable to handle "+t),this):this.growthChangesLength},o.prototype.totalArea=function(t){return arguments.length?(parseFloat(t)>0?this.totalAvailableArea=parseFloat(t):console.warn("FlickeringMitigation.totalArea() accepts only positive numbers; unable to handle "+t),this):this.totalAvailableArea},o.prototype.add=function(t){var n,e;return n=this.lastAreaError,this.lastAreaError=t,isNaN(n)||(e=this.lastGrowth,this.lastGrowth=a(this.lastAreaError,n)),isNaN(e)||this.growthChanges.unshift(this.lastGrowth!=e),this.growthChanges.length>this.growthChangesLength&&this.growthChanges.pop(),this},o.prototype.ratio=function(){var t,n=0;if(this.growthChanges.length<this.growthChangesLength)return 0;if(this.lastAreaError>this.totalAvailableArea/10)return 0;for(var e=0;e<this.growthChangesLength;e++)this.growthChanges[e]&&(n+=this.growthChangeWeights[e]);return t=n/this.growthChangeWeightsSum,t>0&&console.log("flickering mitigation ratio: "+Math.floor(1e3*t)/1e3),t},t.voronoiMapSimulation=c,t.voronoiMapInitialPositionRandom=g,t.voronoiMapInitialPositionPie=u,Object.defineProperty(t,"__esModule",{value:!0})});