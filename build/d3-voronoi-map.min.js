!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("d3-polygon"),require("d3-weighted-voronoi")):"function"==typeof define&&define.amd?define(["exports","d3-polygon","d3-weighted-voronoi"],n):n(t.d3=t.d3||{},t.d3,t.d3)}(this,function(t,n,e){"use strict";function i(){this.growthChangesLength=l,this.totalAvailableArea=NaN,this.lastAreaError=NaN,this.lastGrowth=NaN,this.growthChanges=[],this.growthChangeWeights=o(this.growthChangesLength),this.growthChangeWeightsSum=a(this.growthChangeWeights)}function r(t,n){return t>=n?1:-1}function o(t){for(var n=3,e=1,i=1,r=n,o=[],a=0;a<t;a++)o.push(r),r-=e,r<i&&(r=i);return o}function a(t){for(var n=0,e=0;e<t.length;e++)n+=t[e];return n}function h(){function t(t,a,g,l){var c,f,w=!1;for(i!==l.clip()&&(i=l.clip(),r=l.extent(),w=!0),w&&e(),c=o+s*Math.random(),f=h+u*Math.random();!n.polygonContains(i,[c,f]);)c=o+s*Math.random(),f=h+u*Math.random();return[c,f]}function e(){o=r[0][0],a=r[1][0],h=r[0][1],g=r[1][1],s=a-o,u=g-h}var i,r,o,a,h,g,s,u;return t}function g(){function t(t,n,i,r){var h=!1;return o!==r.clip()&&(o=r.clip(),h|=!0),a!==i&&(a=i,h|=!0),h&&e(),[g[0]+Math.cos(l+n*u)*s+.001*(Math.random()-.5),g[1]+Math.sin(l+n*u)*s+.001*(Math.random()-.5)]}function e(){g=n.polygonCentroid(o),s=i(g,o)/2,h=a.length,u=2*Math.PI/h}function i(t,n){for(var e,i=1/0,o=0,a=n[n.length-1],h=n[o];o<n.length;)e=r(t,a,h),e<i&&(i=e),o++,a=h,h=n[o];return i}function r(t,n,e){var i=t[0],r=t[1],o=n[0],a=n[1],h=e[0],g=e[1],s=i-o,u=r-a,l=h-o,c=g-a,f=s*l+u*c,w=l*l+c*c,p=-1;0!=w&&(p=f/w);var d,v;p<0?(d=o,v=a):p>1?(d=h,v=g):(d=o+p*l,v=a+p*c);var C=i-d,y=r-v;return Math.sqrt(C*C+y*y)}var o,a,h,g,s,u,l=0;return t.startAngle=function(n){return arguments.length?(l=n,t):l},t}function s(){function t(t,n,o,a){var g=!1;return i!==a.clip()&&(i=a.clip(),g|=!0),r!==o&&(r=o,g|=!0),g&&e(),h}function e(){o=r.length,a=n.polygonArea(i),h=a/o/2}var i,r,o,a,h;return t}function u(){function t(t){return Math.pow(t,2)}function r(n,e){return t(e.x-n.x)+t(e.y-n.y)}function o(t){w(),v=t.length,C=Math.abs(n.polygonArea(I.clip())),y=L*C,F.clear().totalArea(C);var e,i=0,r=p(t),o=!1;for(G(r,i);!(o||i>=P);)r=a(r,F.ratio()),i++,e=f(r),F.add(e),o=e<y,G(r,i);return{polygons:r,iterationCount:i,convergenceRatio:e/C}}function a(t,n){var e;return g(t,n),e=t.map(function(t){return t.site.originalObject}),t=I(e),t.length<v&&console.log("at least 1 site has no area, which is not supposed to arise"),u(t,n),e=t.map(function(t){return t.site.originalObject}),t=I(e),t.length<v&&console.log("at least 1 site has no area, which is not supposed to arise"),t}function g(t,e){var i,r,o,a,h,g,s,u=[],l=.5;i=l*e,r=1-i;for(var c=0;c<v;c++)o=t[c],a=o.site.originalObject,h=n.polygonCentroid(o),g=h[0]-a.x,s=h[1]-a.y,g*=r,s*=r,a.x+=g,a.y+=s,u.push(a);A(u)}function u(t,e){var i,r,o,a,h,g,s=[],u=.1;i=u*e;for(var l=0;l<v;l++)r=t[l],o=r.site.originalObject,a=n.polygonArea(r),h=o.targetedArea/a,h=Math.max(h,1-u+i),h=Math.min(h,1+u-i),g=o.weight*h,g=Math.max(g,W),o.weight=g,s.push(o);A(s)}function l(t){var n,e,i,o,a,h,g,s=0;do{n=!1;for(var u=0;u<v;u++){e=t[u];for(var l=u+1;l<v;l++)if(i=t[l],e.weight>i.weight?(o=e,a=i):(o=i,a=e),h=r(e,i),h<o.weight-a.weight){g=h+a.weight/2,g=Math.max(g,W),o.weight=g,n=!0,s++;break}if(n)break}}while(n)}function c(t){var n,e,i,o,a,h,g,s=0;do{n=!1;for(var u=0;u<v;u++){e=t[u];for(var l=u+1;l<v;l++)if(i=t[l],e.weight>i.weight?(o=e,a=i):(o=i,a=e),h=r(e,i),h<o.weight-a.weight){g=o.weight-a.weight-h,a.weight+=g+W,n=!0,s++;break}if(n)break}}while(n)}function f(t){for(var e,i,r,o=0,a=0;a<v;a++)e=t[a],i=e.site.originalObject,r=n.polygonArea(e),o+=Math.abs(i.targetedArea-r);return o}function w(){switch(R){case 0:A=l;break;case 1:A=c;break;default:console.log("Variant of 'handleOverweighted' is unknown")}}function p(t){var n,e,i=t.reduce(function(t,n){return Math.max(t,k(n))},-(1/0)),r=i*j;return n=t.map(function(t,n,e){return{index:n,weight:Math.max(k(t),r),initialPosition:E(t,n,e,o),initialWeight:O(t,n,e,o),originalData:t}}),e=d(n),I(e)}function d(t){var e,i=t.reduce(function(t,n){return t+=n.weight},0);return t.map(function(t,r,a){return e=t.initialPosition,n.polygonContains(I.clip(),e)||(e=x(t,r,a,o)),{index:t.index,targetedArea:C*t.weight/i,data:t,x:e[0],y:e[1],weight:t.initialWeight}})}var v,C,y,A,m=.01,M=50,b=.01,x=h(),N=s(),W=1,k=function(t){return t.weight},L=m,P=M,j=b,E=x,O=N,G=function(t,n){return!0},I=e.weightedVoronoi(),F=new i,R=1;return o.weight=function(t){return arguments.length?(k=t,o):k},o.convergenceRatio=function(t){return arguments.length?(L=t,o):L},o.maxIterationCount=function(t){return arguments.length?(P=t,o):P},o.minWeightRatio=function(t){return arguments.length?(j=t,o):j},o.tick=function(t){return arguments.length?(G=t,o):G},o.clip=function(t){return arguments.length?(I.clip(t),o):I.clip()},o.extent=function(t){return arguments.length?(I.extent(t),o):I.extent()},o.size=function(t){return arguments.length?(I.size(t),o):I.size()},o.initialPosition=function(t){return arguments.length?(E=t,o):E},o.initialWeight=function(t){return arguments.length?(O=t,o):O},o}var l=10;i.prototype.reset=function(){return this.lastAreaError=NaN,this.lastGrowth=NaN,this.growthChanges=[],this.growthChangesLength=l,this.growthChangeWeights=o(this.growthChangesLength),this.growthChangeWeightsSum=a(this.growthChangeWeights),this.totalAvailableArea=NaN,this},i.prototype.clear=function(){return this.lastAreaError=NaN,this.lastGrowth=NaN,this.growthChanges=[],this},i.prototype.length=function(t){return arguments.length?(parseInt(t)>0?(this.growthChangesLength=Math.floor(parseInt(t)),this.growthChangeWeights=o(this.growthChangesLength),this.growthChangeWeightsSum=a(this.growthChangeWeights)):console.warn("FlickeringMitigation.length() accepts only positive integers; unable to handle "+t),this):this.growthChangesLength},i.prototype.totalArea=function(t){return arguments.length?(parseFloat(t)>0?this.totalAvailableArea=parseFloat(t):console.warn("FlickeringMitigation.totalArea() accepts only positive numbers; unable to handle "+t),this):this.totalAvailableArea},i.prototype.add=function(t){var n,e;return n=this.lastAreaError,this.lastAreaError=t,isNaN(n)||(e=this.lastGrowth,this.lastGrowth=r(this.lastAreaError,n)),isNaN(e)||this.growthChanges.unshift(this.lastGrowth!=e),this.growthChanges.length>this.growthChangesLength&&this.growthChanges.pop(),this},i.prototype.ratio=function(){var t,n=0;if(this.growthChanges.length<this.growthChangesLength)return 0;if(this.lastAreaError>this.totalAvailableArea/10)return 0;for(var e=0;e<this.growthChangesLength;e++)this.growthChanges[e]&&(n+=this.growthChangeWeights[e]);return t=n/this.growthChangeWeightsSum,t>0&&console.log("flickering mitigation ratio: "+Math.floor(1e3*t)/1e3),t},t.voronoiMap=u,t.voronoiMapInitialPositionRandom=h,t.voronoiMapInitialPositionPie=g,Object.defineProperty(t,"__esModule",{value:!0})});